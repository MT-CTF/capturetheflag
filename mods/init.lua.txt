local INVIS_DURATION = 10
local invisible_players = {}

minetest.register_craftitem("invis_potion:potion", {
    description = "Invisible Potion",
    inventory_image = "invis_potion.png",
    on_use = function(itemstack, user, pointed_thing)
        if not user or not user:is_player() then return end
        local name = user:get_player_name()

        user:set_properties({
            visual_size = {x = 0, y = 0},
            makes_footstep_sound = false
        })
        user:set_observers({})
        invisible_players[name] = true

        local pos = user:get_pos()
        minetest.add_particlespawner({
            amount = 100,
            time = INVIS_DURATION,
            minpos = pos,
            maxpos = pos,
            minvel = {x=-1, y=0.5, z=-1},
            maxvel = {x=1, y=2, z=1},
            minacc = {x=0, y=-0.5, z=0},
            maxacc = {x=0, y=-1, z=0},
            minexptime = 1,
            maxexptime = 2,
            minsize = 1,
            maxsize = 2,
            texture = "bubble.png",
            playername = name
        })

        minetest.after(INVIS_DURATION, function()
            if user and user:is_player() then
                user:set_properties({
                    visual_size = {x = 1, y = 1},
                    makes_footstep_sound = true
                })
                user:set_observers(nil)
                invisible_players[name] = nil
            end
        end)

        itemstack:take_item()
        return itemstack
    end,
})

minetest.register_on_punchplayer(function(player, hitter, time_from_last_punch, tool_capabilities, dir, damage)
    if hitter and hitter:is_player() then
        local name = hitter:get_player_name()
        if invisible_players[name] then
            return true
        end
    end
end)